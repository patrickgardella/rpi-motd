#!/bin/bash
#
# display partition usage if partition > 70% full
# version 1.00
# anita2R May 2015
# ******************************************************************************
#   This file can be edited - the 'do not edit' message will appear at the top
#              of the output file '/etc/update-motd.d/15-disk-space'
#                         which should not be edited
# ******************************************************************************
# If you run this file directly or through 'run-parts /etc/update-motd-static.d'
#          the output will appear in /etc/update-motd.d/15-disk-space
#                            and not on the screen
# ******************************************************************************
#
# To control message formatting this function places text
#  at left side of box and and puts some '#'s around it
left(){
SP=$(( 62 - ${#1} ))
FLM=" # $1"$(printf %"$SP"s)"#"
}
#
# get partition information using 'df' - output information only if usage excedes 70%
## attached devices if any - reported as /dev/sda1 etc.
HD=$(df -l | grep /dev/sd | awk '{if (0+$5 > 70) print $1"at"$5" "}')
## SD card partitions
SD=$(df -l | grep mmcblk | awk '{if (0+$5 > 70) print $1"at"$5" "}')
p2=$(df / | grep root | awk '{if (0+$5 > 70) print $1"at"$5}')
#
# mmcblk0p2 appears as /dev/root - replace 'root' with 'mmcblk0p2' for consistency
p2=$(echo "$p2" | sed 's/root/mmcblk0p2/')
# put the messages together and remove the '/dev' prefixes 
diskMsg=$(echo "$HD$SD$p2" | sed 's/\/dev\///g')
#
# $diskMsg will be empty (and hence 'false') if NO partition is over 70% full
if [[ "$diskMsg" ]]
        then
        left "The following partitions are over 70% full:"
        MSG="$FLM\n"
        for disk in $diskMsg
                do
                # put spaces around 'at' e.g. mmcblk0p1at75% > mmcblk0p1 at 75%
                disk=$(echo "$disk" | sed 's/at/ at /')
                left "  $disk"
                MSG="$MSG""$FLM\n"
        done
        else
        left "All partitions have at least 30% free space"
        MSG="$FLM\n"
fi
#
# end of pre-processing
#
OUT="/etc/update-motd.d/"$(basename $0)
exec >${OUT}
#
echo "#!/bin/bash"
echo "###########################################"
echo "#         DO NOT EDIT THIS FILE           #"
echo "#      EDIT the 15-disk-space file        #"
echo "# in the /etc/update-motd-static.d folder #"
echo "###########################################"
#
echo "cat << EOF"
echo -e  -n "$MSG"
echo " #                                                               #"
echo "EOF"
